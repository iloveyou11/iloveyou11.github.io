<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>koa+nuxt基础 | blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="YP's Blog"><meta name="description" content="koa一、开始async/await 使用123456789101112131415161718192021222324252627function getSyncTime() &amp;#123;  return new Promise((resolve, reject) =&amp;gt; &amp;#123;    try &amp;#123;      let startTime = new Date().getTime"><meta name="keywords" content="web"><meta property="og:type" content="article"><meta property="og:title" content="koa+nuxt基础"><meta property="og:url" content="http://localhost:4000/2019/06/10/koa+nuxt基础/index.html"><meta property="og:site_name" content="blog"><meta property="og:description" content="koa一、开始async/await 使用123456789101112131415161718192021222324252627function getSyncTime() &amp;#123;  return new Promise((resolve, reject) =&amp;gt; &amp;#123;    try &amp;#123;      let startTime = new Date().getTime"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2020-07-06T06:21:54.628Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="koa+nuxt基础"><meta name="twitter:description" content="koa一、开始async/await 使用123456789101112131415161718192021222324252627function getSyncTime() &amp;#123;  return new Promise((resolve, reject) =&amp;gt; &amp;#123;    try &amp;#123;      let startTime = new Date().getTime"><link rel="icon" href="/favicon.ico"><link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/css/style.css"><script src="/js/pace.min.js"></script></head></html><body><div id="container"><header id="header"><div id="banner"></div><div id="header-outer"><div id="header-menu" class="header-menu-pos animated"><div class="header-menu-container"><a href="/" class="left"><span class="site-title">YP&#39;s Blog</span></a><nav id="header-menu-nav" class="right"><a href="/"><i class="fa fa-home"></i> <span>主页</span> </a><a href="/archives"><i class="fa fa-archive"></i> <span>全部</span> </a><a href="/categories/AI/"><i class="fa fa-AI"></i> <span>AI</span> </a><a href="/categories/前端/"><i class="fa fa-前端"></i> <span>前端</span> </a><a href="/categories/计算机/"><i class="fa fa-计算机"></i> <span>计算机</span> </a><a href="/categories/语言/"><i class="fa fa-语言"></i> <span>语言</span> </a><a href="/categories/专题/"><i class="fa fa-专题"></i> <span>专题</span></a></nav><a class="mobile-header-menu-button"><i class="fa fa-bars"></i></a></div></div><div id="header-row"><div id="logo"><a href="/"><img src="/images/logo.png" alt="logo"></a></div><div class="header-info"><div id="header-title"><h2>YP&#39;s Blog</h2></div><div id="header-description"><h3>一个专注前端智能化开发的技术博客</h3></div></div><nav class="header-nav"><div class="social"><a title="Blog" target="_blank" href="https://iloveyou11.github.io/"><i class="fa fa-home fa-2x"></i></a> <a title="Github" target="_blank" href="https://github.com/iloveyou11"><i class="fa fa-github fa-2x"></i></a></div></nav></div></div></header><div class="outer"><section id="main" class="body-wrap"><article id="post-koa+nuxt基础" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="post-title" itemprop="name">koa+nuxt基础</h1><div class="post-title-bar"><ul><li><i class="fa fa-book"></i> <a href="/categories/前端/">前端</a></li><li><i class="fa fa-calendar"></i> 2019-06-10</li><li><i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"></span></li></ul></div><div style="margin-top:10px"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i> <span class="post-meta-item-text">字数统计: </span><span class="post-count">4k字</span> </span></span><span class="post-time">&nbsp; | &nbsp; <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i> <span class="post-meta-item-text">阅读时长: </span><span class="post-count">20分</span></span></span></div></header><div class="article-entry post-content" itemprop="articleBody"><div id="toc"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#koa"><span class="toc-text">koa</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#一、开始"><span class="toc-text">一、开始</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#二、路由"><span class="toc-text">二、路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#三、请求数据"><span class="toc-text">三、请求数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#四、静态资源加载"><span class="toc-text">四、静态资源加载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#五、cookie-和-session"><span class="toc-text">五、cookie 和 session</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#六、模板引擎"><span class="toc-text">六、模板引擎</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#七、文件上传"><span class="toc-text">七、文件上传</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#八、数据库-mysql"><span class="toc-text">八、数据库 mysql</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#九、jsonp"><span class="toc-text">九、jsonp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#十、单元测试"><span class="toc-text">十、单元测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nuxt"><span class="toc-text">nuxt</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#nuxt-官方文档-https-zh-nuxtjs-org-guide"><span class="toc-text">nuxt 官方文档 https://zh.nuxtjs.org/guide/</span></a></li></ol></li></ol></div><a id="more"></a><h4 id="koa"><a href="#koa" class="headerlink" title="koa"></a>koa</h4><h5 id="一、开始"><a href="#一、开始" class="headerlink" title="一、开始"></a>一、开始</h5><!-- more --><p><strong>async/await 使用</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSyncTime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> startTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> endTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">        <span class="keyword">let</span> data = endTime - startTime;</span><br><span class="line">        resolve(data);</span><br><span class="line">      &#125;, <span class="number">500</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getSyncData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> time = <span class="keyword">await</span> getSyncTime();</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">`endTime - startTime = <span class="subst">$&#123;time&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = <span class="keyword">await</span> getSyncData();</span><br><span class="line">  <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getData();</span><br></pre></td></tr></table></figure><p><strong>中间件的使用（async 中间件只能在 koa v2 中使用）</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ./middleware/logger-async.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(ctx.method, ctx.header.host + ctx.url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    log(ctx);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>); <span class="comment">// koa v2</span></span><br><span class="line"><span class="keyword">const</span> loggerAsync = <span class="built_in">require</span>(<span class="string">"./middleware/logger-async"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(loggerAsync());</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">  ctx.body = <span class="string">"hello world!"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"the server is starting at port 3000"</span>);</span><br></pre></td></tr></table></figure><h5 id="二、路由"><a href="#二、路由" class="headerlink" title="二、路由"></a>二、路由</h5><p><strong>koa-router 路由的使用</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">"koa-router"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子路由1</span></span><br><span class="line"><span class="keyword">let</span> home = <span class="keyword">new</span> Router();</span><br><span class="line">home.get(<span class="string">"/"</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;ul&gt;</span></span><br><span class="line"><span class="string">        &lt;li&gt;&lt;a href="/page/helloworld"&gt;/page/helloworld&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;li&gt;&lt;a href="/page/404"&gt;/page/404&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;/ul&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">  ctx.body = html;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子路由2</span></span><br><span class="line"><span class="keyword">let</span> page = <span class="keyword">new</span> Router();</span><br><span class="line">page</span><br><span class="line">  .get(<span class="string">"/404"</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    ctx.body = <span class="string">"404 page!"</span>;</span><br><span class="line">  &#125;)</span><br><span class="line">  .get(<span class="string">"/helloworld"</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    ctx.body = <span class="string">"helloworld page!"</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 装载所有子路由</span></span><br><span class="line"><span class="keyword">let</span> router = <span class="keyword">new</span> Router();</span><br><span class="line">router.use(<span class="string">"/"</span>, home.routes(), home.allowedMethods());</span><br><span class="line">router.use(<span class="string">"/page"</span>, page.routes(), page.allowedMethods());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载路由中间件</span></span><br><span class="line">app.use(router.routes()).use(router.allowedMethods());</span><br><span class="line"><span class="comment">// 监听端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"[demo] route-use-middleware is starting at port 3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="三、请求数据"><a href="#三、请求数据" class="headerlink" title="三、请求数据"></a>三、请求数据</h5><p><strong>请求数据的获取</strong> 1.是从上下文中直接获取<br>请求对象 ctx.query，返回如 { a:1, b:2 }<br>请求字符串 ctx.querystring，返回如 a=1&amp;b=2 2.是从上下文的 request 对象中获取<br>请求对象 ctx.request.query，返回如 { a:1, b:2 }<br>请求字符串 ctx.request.querystring，返回如 a=1&amp;b=2</p><p><strong><em>get</em></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> url = ctx.url;</span><br><span class="line">  <span class="comment">// 从上下文的request对象中获取</span></span><br><span class="line">  <span class="keyword">let</span> request = ctx.request;</span><br><span class="line">  <span class="keyword">let</span> req_query = request.query;</span><br><span class="line">  <span class="keyword">let</span> req_querystring = request.querystring;</span><br><span class="line">  <span class="comment">// 从上下文中直接获取</span></span><br><span class="line">  <span class="keyword">let</span> ctx_query = ctx.query;</span><br><span class="line">  <span class="keyword">let</span> ctx_querystring = ctx.querystring;</span><br><span class="line"></span><br><span class="line">  ctx.body = &#123;</span><br><span class="line">    url,</span><br><span class="line">    req_query,</span><br><span class="line">    req_querystring,</span><br><span class="line">    ctx_query,</span><br><span class="line">    ctx_querystring</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong><em>post</em></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (ctx.url === <span class="string">"/"</span> &amp;&amp; ctx.method === <span class="string">"GET"</span>) &#123;</span><br><span class="line">    <span class="comment">// 当GET请求时候返回表单页面</span></span><br><span class="line">    <span class="keyword">let</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;h1&gt;koa2 request post demo&lt;/h1&gt;</span></span><br><span class="line"><span class="string">      &lt;form method="POST" action="/"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;userName&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="userName" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;nickName&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="nickName" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;email&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="email" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;button type="submit"&gt;submit&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;/form&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">    ctx.body = html;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctx.url === <span class="string">"/"</span> &amp;&amp; ctx.method === <span class="string">"POST"</span>) &#123;</span><br><span class="line">    <span class="comment">// 当POST请求的时候，解析POST表单里的数据，并显示出来</span></span><br><span class="line">    <span class="keyword">let</span> postData = <span class="keyword">await</span> parsePostData(ctx);</span><br><span class="line">    ctx.body = postData;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其他请求显示404</span></span><br><span class="line">    ctx.body = <span class="string">"&lt;h1&gt;404！！！ o(╯□╰)o&lt;/h1&gt;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析上下文里node原生请求的POST参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parsePostData</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> postdata = <span class="string">""</span>;</span><br><span class="line">      ctx.req.addListener(<span class="string">"data"</span>, data =&gt; &#123;</span><br><span class="line">        postdata += data;</span><br><span class="line">      &#125;);</span><br><span class="line">      ctx.req.addListener(<span class="string">"end"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> parseData = parseQueryStr(postdata);</span><br><span class="line">        resolve(parseData);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将POST请求参数字符串解析成JSON</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseQueryStr</span>(<span class="params">queryStr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> queryData = &#123;&#125;;</span><br><span class="line">  <span class="keyword">let</span> queryStrList = queryStr.split(<span class="string">"&amp;"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(queryStrList);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> [index, queryStr] <span class="keyword">of</span> queryStrList.entries()) &#123;</span><br><span class="line">    <span class="keyword">let</span> itemList = queryStr.split(<span class="string">"="</span>);</span><br><span class="line">    queryData[itemList[<span class="number">0</span>]] = <span class="built_in">decodeURIComponent</span>(itemList[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> queryData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"[demo] request post is starting at port 3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong><em>koa-bodyparser 中间件</em></strong><br>对于 POST 请求的处理，koa-bodyparser 中间件可以把 koa2 上下文的 formData 数据解析到 ctx.request.body 中</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">"koa-bodyparser"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用ctx.body解析中间件</span></span><br><span class="line">app.use(bodyParser());</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (ctx.url === <span class="string">"/"</span> &amp;&amp; ctx.method === <span class="string">"GET"</span>) &#123;</span><br><span class="line">    <span class="comment">// 当GET请求时候返回表单页面</span></span><br><span class="line">    <span class="keyword">let</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;h1&gt;koa2 request post demo&lt;/h1&gt;</span></span><br><span class="line"><span class="string">      &lt;form method="POST" action="/"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;userName&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="userName" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;nickName&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="nickName" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;email&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="email" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;button type="submit"&gt;submit&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;/form&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">    ctx.body = html;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctx.url === <span class="string">"/"</span> &amp;&amp; ctx.method === <span class="string">"POST"</span>) &#123;</span><br><span class="line">    <span class="comment">// 当POST请求的时候，解析POST表单里的数据，并显示出来</span></span><br><span class="line">    <span class="keyword">let</span> postData = ctx.request.body;</span><br><span class="line">    ctx.body = postData;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其他请求显示404</span></span><br><span class="line">    ctx.body = <span class="string">"&lt;h1&gt;404！！！ o(╯□╰)o&lt;/h1&gt;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"[demo] request post is starting at port 3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="四、静态资源加载"><a href="#四、静态资源加载" class="headerlink" title="四、静态资源加载"></a>四、静态资源加载</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">"koa-static"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态资源目录对于相对入口文件index.js的路径</span></span><br><span class="line"><span class="keyword">const</span> staticPath = <span class="string">"./static"</span>;</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">static</span>(path.join(__dirname, staticPath)));</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">"hello world"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"[demo] static-use-middleware is starting at port 3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="五、cookie-和-session"><a href="#五、cookie-和-session" class="headerlink" title="五、cookie 和 session"></a>五、cookie 和 session</h5><p><strong>cookie</strong><br>koa 提供了从上下文直接读取、写入 cookie 的方法<br>ctx.cookies.get(name, [options]) 读取上下文请求中的 cookie<br>ctx.cookies.set(name, value, [options]) 在上下文中写入 cookie</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (ctx.url === <span class="string">"/index"</span>) &#123;</span><br><span class="line">    ctx.cookies.set(<span class="string">"cid"</span>, <span class="string">"hello world"</span>, &#123;</span><br><span class="line">      domain: <span class="string">"localhost"</span>, <span class="comment">// 写cookie所在的域名</span></span><br><span class="line">      path: <span class="string">"/index"</span>, <span class="comment">// 写cookie所在的路径</span></span><br><span class="line">      maxAge: <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>, <span class="comment">// cookie有效时长</span></span><br><span class="line">      expires: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">"2017-02-15"</span>), <span class="comment">// cookie失效时间</span></span><br><span class="line">      httpOnly: <span class="literal">false</span>, <span class="comment">// 是否只用于http请求中获取</span></span><br><span class="line">      overwrite: <span class="literal">false</span> <span class="comment">// 是否允许重写</span></span><br><span class="line">    &#125;);</span><br><span class="line">    ctx.body = <span class="string">"cookie is ok"</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">"hello world"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"[demo] cookie is starting at port 3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>session</strong><br>koa2 原生功能只提供了 cookie 的操作，但是没有提供 session 操作。session 就只用自己实现或者通过第三方中间件实现。在 koa2 中实现 session 的方案有一下几种</p><p>如果 session 数据量很小，可以直接存在内存中<br>如果 session 数据量很大，则需要存储介质存放 session 数据</p><p>将 session 存放在 MySQL 数据库中<br>需要用到中间件<br>koa-session-minimal 适用于 koa2 的 session 中间件，提供存储介质的读写接口 。<br>koa-mysql-session 为 koa-session-minimal 中间件提供 MySQL 数据库的 session 数据读写操作。<br>将 sessionId 和对于的数据存到数据库<br>将数据库的存储的 sessionId 存到页面的 cookie 中<br>根据 cookie 的 sessionId 去获取对于的 session 信息</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">"koa-session-minimal"</span>);</span><br><span class="line"><span class="keyword">const</span> MysqlSession = <span class="built_in">require</span>(<span class="string">"koa-mysql-session"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置存储session信息的mysql</span></span><br><span class="line"><span class="keyword">let</span> store = <span class="keyword">new</span> MysqlSession(&#123;</span><br><span class="line">  user: <span class="string">"root"</span>,</span><br><span class="line">  password: <span class="string">"abc123"</span>,</span><br><span class="line">  database: <span class="string">"koa_demo"</span>,</span><br><span class="line">  host: <span class="string">"127.0.0.1"</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存放sessionId的cookie配置</span></span><br><span class="line"><span class="keyword">let</span> cookie = &#123;</span><br><span class="line">  maxAge: <span class="string">""</span>, <span class="comment">// cookie有效时长</span></span><br><span class="line">  expires: <span class="string">""</span>, <span class="comment">// cookie失效时间</span></span><br><span class="line">  path: <span class="string">""</span>, <span class="comment">// 写cookie所在的路径</span></span><br><span class="line">  domain: <span class="string">""</span>, <span class="comment">// 写cookie所在的域名</span></span><br><span class="line">  httpOnly: <span class="string">""</span>, <span class="comment">// 是否只用于http请求中获取</span></span><br><span class="line">  overwrite: <span class="string">""</span>, <span class="comment">// 是否允许重写</span></span><br><span class="line">  secure: <span class="string">""</span>,</span><br><span class="line">  sameSite: <span class="string">""</span>,</span><br><span class="line">  signed: <span class="string">""</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(</span><br><span class="line">  session(&#123;</span><br><span class="line">    key: <span class="string">"SESSION_ID"</span>,</span><br><span class="line">    store: store,</span><br><span class="line">    cookie: cookie</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="comment">// 设置session</span></span><br><span class="line">  <span class="keyword">if</span> (ctx.url === <span class="string">"/set"</span>) &#123;</span><br><span class="line">    ctx.session = &#123;</span><br><span class="line">      user_id: <span class="built_in">Math</span>.random()</span><br><span class="line">        .toString(<span class="number">36</span>)</span><br><span class="line">        .substr(<span class="number">2</span>),</span><br><span class="line">      count: <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ctx.body = ctx.session;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctx.url === <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="comment">// 读取session信息</span></span><br><span class="line">    ctx.session.count = ctx.session.count + <span class="number">1</span>;</span><br><span class="line">    ctx.body = ctx.session;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[demo] session is starting at port 3000"</span>);</span><br></pre></td></tr></table></figure><h5 id="六、模板引擎"><a href="#六、模板引擎" class="headerlink" title="六、模板引擎"></a>六、模板引擎</h5><p><strong>安装 koa 模板使用中间件</strong><br>npm install –save koa-views<br><strong>安装 ejs 模板引擎</strong><br>npm install –save ejs</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">"koa-views"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载模板引擎</span></span><br><span class="line">app.use(</span><br><span class="line">  views(path.join(__dirname, <span class="string">"./view"</span>), &#123;</span><br><span class="line">    extension: <span class="string">"ejs"</span></span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> title = <span class="string">"hello koa2"</span>;</span><br><span class="line">  <span class="keyword">await</span> ctx.render(<span class="string">"index"</span>, &#123;</span><br><span class="line">    title</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><h5 id="七、文件上传"><a href="#七、文件上传" class="headerlink" title="七、文件上传"></a>七、文件上传</h5><p><strong>busboy 模块</strong><br>npm install –save busboy</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inspect = <span class="built_in">require</span>(<span class="string">"util"</span>).inspect;</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> Busboy = <span class="built_in">require</span>(<span class="string">"busboy"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// req 为node原生请求</span></span><br><span class="line"><span class="keyword">const</span> busboy = <span class="keyword">new</span> Busboy(&#123; <span class="attr">headers</span>: req.headers &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听文件解析事件</span></span><br><span class="line">busboy.on(<span class="string">"file"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, file, filename, encoding, mimetype</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`File [<span class="subst">$&#123;fieldname&#125;</span>]: filename: <span class="subst">$&#123;filename&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 文件保存到特定路径</span></span><br><span class="line">  file.pipe(fs.createWriteStream(<span class="string">"./upload"</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始解析文件流</span></span><br><span class="line">  file.on(<span class="string">"data"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`File [<span class="subst">$&#123;fieldname&#125;</span>] got <span class="subst">$&#123;data.length&#125;</span> bytes`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析文件结束</span></span><br><span class="line">  file.on(<span class="string">"end"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`File [<span class="subst">$&#123;fieldname&#125;</span>] Finished`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听请求中的字段</span></span><br><span class="line">busboy.on(<span class="string">"field"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, val, fieldnameTruncated, valTruncated</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Field [<span class="subst">$&#123;fieldname&#125;</span>]: value: <span class="subst">$&#123;inspect(val)&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听结束事件</span></span><br><span class="line">busboy.on(<span class="string">"finish"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Done parsing form!"</span>);</span><br><span class="line">  res.writeHead(<span class="number">303</span>, &#123; <span class="attr">Connection</span>: <span class="string">"close"</span>, <span class="attr">Location</span>: <span class="string">"/"</span> &#125;);</span><br><span class="line">  res.end();</span><br><span class="line">&#125;);</span><br><span class="line">req.pipe(busboy);</span><br></pre></td></tr></table></figure><p><strong>上传文件简单实现</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inspect = <span class="built_in">require</span>(<span class="string">"util"</span>).inspect;</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">"os"</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> Busboy = <span class="built_in">require</span>(<span class="string">"busboy"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步创建文件目录</span></span><br><span class="line"><span class="comment"> * @param  &#123;string&#125; dirname 目录绝对地址</span></span><br><span class="line"><span class="comment"> * @return &#123;boolean&#125;        创建目录结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdirsSync</span>(<span class="params">dirname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync(dirname)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mkdirsSync(path.dirname(dirname))) &#123;</span><br><span class="line">      fs.mkdirSync(dirname);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取上传文件的后缀名</span></span><br><span class="line"><span class="comment"> * @param  &#123;string&#125; fileName 获取上传文件的后缀名</span></span><br><span class="line"><span class="comment"> * @return &#123;string&#125;          文件后缀名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSuffixName</span>(<span class="params">fileName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> nameList = fileName.split(<span class="string">"."</span>);</span><br><span class="line">  <span class="keyword">return</span> nameList[nameList.length - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件</span></span><br><span class="line"><span class="comment"> * @param  &#123;object&#125; ctx     koa上下文</span></span><br><span class="line"><span class="comment"> * @param  &#123;object&#125; options 文件上传参数 fileType文件类型， path文件存放路径</span></span><br><span class="line"><span class="comment"> * @return &#123;promise&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span>(<span class="params">ctx, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> req = ctx.req;</span><br><span class="line">  <span class="keyword">let</span> res = ctx.res;</span><br><span class="line">  <span class="keyword">let</span> busboy = <span class="keyword">new</span> Busboy(&#123; <span class="attr">headers</span>: req.headers &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取类型</span></span><br><span class="line">  <span class="keyword">let</span> fileType = options.fileType || <span class="string">"common"</span>;</span><br><span class="line">  <span class="keyword">let</span> filePath = path.join(options.path, fileType);</span><br><span class="line">  <span class="keyword">let</span> mkdirResult = mkdirsSync(filePath);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"文件上传中..."</span>);</span><br><span class="line">    <span class="keyword">let</span> result = &#123;</span><br><span class="line">      success: <span class="literal">false</span>,</span><br><span class="line">      formData: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析请求文件事件</span></span><br><span class="line">    busboy.on(<span class="string">"file"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, file, filename, encoding, mimetype</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> fileName =</span><br><span class="line">        <span class="built_in">Math</span>.random()</span><br><span class="line">          .toString(<span class="number">16</span>)</span><br><span class="line">          .substr(<span class="number">2</span>) +</span><br><span class="line">        <span class="string">"."</span> +</span><br><span class="line">        getSuffixName(filename);</span><br><span class="line">      <span class="keyword">let</span> _uploadFilePath = path.join(filePath, fileName);</span><br><span class="line">      <span class="keyword">let</span> saveTo = path.join(_uploadFilePath);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 文件保存到制定路径</span></span><br><span class="line">      file.pipe(fs.createWriteStream(saveTo));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 文件写入事件结束</span></span><br><span class="line">      file.on(<span class="string">"end"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        result.success = <span class="literal">true</span>;</span><br><span class="line">        result.message = <span class="string">"文件上传成功"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"文件上传成功！"</span>);</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析表单中其他字段信息</span></span><br><span class="line">    busboy.on(<span class="string">"field"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      fieldname,</span></span></span><br><span class="line"><span class="function"><span class="params">      val,</span></span></span><br><span class="line"><span class="function"><span class="params">      fieldnameTruncated,</span></span></span><br><span class="line"><span class="function"><span class="params">      valTruncated,</span></span></span><br><span class="line"><span class="function"><span class="params">      encoding,</span></span></span><br><span class="line"><span class="function"><span class="params">      mimetype</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"表单字段数据 ["</span> + fieldname + <span class="string">"]: value: "</span> + inspect(val));</span><br><span class="line">      result.formData[fieldname] = inspect(val);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析结束事件</span></span><br><span class="line">    busboy.on(<span class="string">"finish"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"文件上结束"</span>);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析错误事件</span></span><br><span class="line">    busboy.on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"文件上出错"</span>);</span><br><span class="line">      reject(result);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    req.pipe(busboy);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  uploadFile</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>入口文件</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="comment">// const bodyParser = require('koa-bodyparser')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; uploadFile &#125; = <span class="built_in">require</span>(<span class="string">"./util/upload"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.use(bodyParser())</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (ctx.url === <span class="string">"/"</span> &amp;&amp; ctx.method === <span class="string">"GET"</span>) &#123;</span><br><span class="line">    <span class="comment">// 当GET请求时候返回表单页面</span></span><br><span class="line">    <span class="keyword">let</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;h1&gt;koa2 upload demo&lt;/h1&gt;</span></span><br><span class="line"><span class="string">      &lt;form method="POST" action="/upload.json" enctype="multipart/form-data"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;file upload&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;span&gt;picName:&lt;/span&gt;&lt;input name="picName" type="text" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="file" type="file" /&gt;&lt;br/&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;button type="submit"&gt;submit&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;/form&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">    ctx.body = html;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctx.url === <span class="string">"/upload.json"</span> &amp;&amp; ctx.method === <span class="string">"POST"</span>) &#123;</span><br><span class="line">    <span class="comment">// 上传文件请求处理</span></span><br><span class="line">    <span class="keyword">let</span> result = &#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> serverFilePath = path.join(__dirname, <span class="string">"upload-files"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传文件事件</span></span><br><span class="line">    result = <span class="keyword">await</span> uploadFile(ctx, &#123;</span><br><span class="line">      fileType: <span class="string">"album"</span>, <span class="comment">// common or album</span></span><br><span class="line">      path: serverFilePath</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    ctx.body = result;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其他请求显示404</span></span><br><span class="line">    ctx.body = <span class="string">"&lt;h1&gt;404！！！ o(╯□╰)o&lt;/h1&gt;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"[demo] upload-simple is starting at port 3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>异步上传图片实现</strong><br>参考网址：<a href="https://chenshenhai.github.io/koa2-note/note/upload/pic-async.html" target="_blank" rel="noopener">https://chenshenhai.github.io/koa2-note/note/upload/pic-async.html</a></p><h5 id="八、数据库-mysql"><a href="#八、数据库-mysql" class="headerlink" title="八、数据库 mysql"></a>八、数据库 mysql</h5><p>npm install –save mysql<br><strong>创建数据库会话</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">"mysql"</span>);</span><br><span class="line"><span class="keyword">const</span> connection = mysql.createConnection(&#123;</span><br><span class="line">  host: <span class="string">"127.0.0.1"</span>, <span class="comment">// 数据库地址</span></span><br><span class="line">  user: <span class="string">"root"</span>, <span class="comment">// 数据库用户</span></span><br><span class="line">  password: <span class="string">"123456"</span>, <span class="comment">// 数据库密码</span></span><br><span class="line">  database: <span class="string">"my_database"</span> <span class="comment">// 选中数据库</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行sql脚本对数据库进行读写</span></span><br><span class="line">connection.query(<span class="string">"SELECT * FROM my_table"</span>, (error, results, fields) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">  connection.release();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>创建数据连接池</strong><br>一般情况下操作数据库是很复杂的读写过程，不只是一个会话，如果直接用会话操作，就需要每次会话都要配置连接参数。所以这时候就需要连接池管理会话。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建数据池</span></span><br><span class="line"><span class="keyword">const</span> pool  = mysql.createPool(&#123;</span><br><span class="line">  host     : <span class="string">'127.0.0.1'</span>,   <span class="comment">// 数据库地址</span></span><br><span class="line">  user     : <span class="string">'root'</span>,    <span class="comment">// 数据库用户</span></span><br><span class="line">  password : <span class="string">'123456'</span>   <span class="comment">// 数据库密码</span></span><br><span class="line">  database : <span class="string">'my_database'</span>  <span class="comment">// 选中数据库</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在数据池中进行会话操作</span></span><br><span class="line">pool.getConnection(<span class="function"><span class="keyword">function</span>(<span class="params">err, connection</span>) </span>&#123;</span><br><span class="line">  connection.query(<span class="string">'SELECT * FROM my_table'</span>,  (error, results, fields) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 结束会话</span></span><br><span class="line">    connection.release();</span><br><span class="line">    <span class="comment">// 如果有错误就抛出</span></span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>async/await 封装使用 mysql</strong><br>由于 mysql 模块的操作都是异步操作，每次操作的结果都是在回调函数中执行，现在有了 async/await，就可以用同步的写法去操作数据库<br><strong><em>Promise 封装 mysql 模块</em></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">"mysql"</span>);</span><br><span class="line"><span class="keyword">const</span> pool = mysql.createPool(&#123;</span><br><span class="line">  host: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">  user: <span class="string">"root"</span>,</span><br><span class="line">  password: <span class="string">"123456"</span>,</span><br><span class="line">  database: <span class="string">"my_database"</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> query = <span class="function"><span class="keyword">function</span>(<span class="params">sql, values</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    pool.getConnection(<span class="function"><span class="keyword">function</span>(<span class="params">err, connection</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        reject(err);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        connection.query(sql, values, (err, rows) =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            reject(err);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve(rows);</span><br><span class="line">          &#125;</span><br><span class="line">          connection.release();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123; query &#125;;</span><br></pre></td></tr></table></figure><p><strong><em>async/await 使用</em></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; query &#125; = <span class="built_in">require</span>(<span class="string">"./async-db"</span>);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">selectAllData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> sql = <span class="string">"SELECT * FROM my_table"</span>;</span><br><span class="line">  <span class="keyword">let</span> dataList = <span class="keyword">await</span> query(sql);</span><br><span class="line">  <span class="keyword">return</span> dataList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> dataList = <span class="keyword">await</span> selectAllData();</span><br><span class="line">  <span class="built_in">console</span>.log(dataList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getData();</span><br></pre></td></tr></table></figure><h5 id="九、jsonp"><a href="#九、jsonp" class="headerlink" title="九、jsonp"></a>九、jsonp</h5><p>在项目复杂的业务场景，有时候需要在前端跨域获取数据，这时候提供数据的服务就需要提供跨域请求的接口，通常是使用 JSONP 的方式提供跨域接口。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="comment">// 如果jsonp 的请求为GET</span></span><br><span class="line">  <span class="keyword">if</span> (ctx.method === <span class="string">"GET"</span> &amp;&amp; ctx.url.split(<span class="string">"?"</span>)[<span class="number">0</span>] === <span class="string">"/getData.jsonp"</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取jsonp的callback</span></span><br><span class="line">    <span class="keyword">let</span> callbackName = ctx.query.callback || <span class="string">"callback"</span>;</span><br><span class="line">    <span class="keyword">let</span> returnData = &#123;</span><br><span class="line">      success: <span class="literal">true</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        text: <span class="string">"this is a jsonp api"</span>,</span><br><span class="line">        time: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// jsonp的script字符串</span></span><br><span class="line">    <span class="keyword">let</span> jsonpStr = <span class="string">`;<span class="subst">$&#123;callbackName&#125;</span>(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(returnData)&#125;</span>)`</span>;</span><br><span class="line">    <span class="comment">// 用text/javascript，让请求支持跨域获取</span></span><br><span class="line">    ctx.type = <span class="string">"text/javascript"</span>;</span><br><span class="line">    <span class="comment">// 输出jsonp字符串</span></span><br><span class="line">    ctx.body = jsonpStr;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">"hello jsonp"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"[demo] jsonp is starting at port 3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>原理：<br>JSONP 跨域输出的数据是可执行的 JavaScript 代码<br>ctx 输出的类型应该是’text/javascript’<br>ctx 输出的内容为可执行的返回数据 JavaScript 代码字符串<br>需要有回调函数名 callbackName，前端获取后会通过动态执行 JavaScript 代码字符，获取里面的数据</p><p><strong>koa-jsonp 中间件</strong><br>npm install –save koa-jsonp</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> jsonp = <span class="built_in">require</span>(<span class="string">"koa-jsonp"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="comment">// 使用中间件</span></span><br><span class="line">app.use(jsonp());</span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> returnData = &#123;</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      text: <span class="string">"this is a jsonp api"</span>,</span><br><span class="line">      time: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 直接输出JSON</span></span><br><span class="line">  ctx.body = returnData;</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"[demo] jsonp is starting at port 3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="十、单元测试"><a href="#十、单元测试" class="headerlink" title="十、单元测试"></a>十、单元测试</h5><p>测试是一个项目周期里必不可少的环节，开发者在开发过程中也是无时无刻进行“人工测试”，如果每次修改一点代码，都要牵一发动全身都要手动测试关联接口，这样子是禁锢了生产力。为了解放大部分测试生产力，相关的测试框架应运而生，比较出名的有 mocha，karma，jasmine 等。虽然框架繁多，但是使用起来都是大同小异。</p><p>npm install –save-dev mocha chai supertest<br><strong>开始写测试用例</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> supertest = <span class="built_in">require</span>(<span class="string">"supertest"</span>);</span><br><span class="line"><span class="keyword">const</span> chai = <span class="built_in">require</span>(<span class="string">"chai"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">"./../index"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> expect = chai.expect;</span><br><span class="line"><span class="keyword">const</span> request = supertest(app.listen());</span><br><span class="line"><span class="comment">// 测试套件/组</span></span><br><span class="line">describe(<span class="string">"开始测试demo的GET请求"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 测试用例</span></span><br><span class="line">  it(<span class="string">"测试/getString.json请求"</span>, done =&gt; &#123;</span><br><span class="line">    request</span><br><span class="line">      .get(<span class="string">"/getString.json"</span>)</span><br><span class="line">      .expect(<span class="number">200</span>)</span><br><span class="line">      .end(<span class="function">(<span class="params">err, res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 断言判断结果是否为object类型</span></span><br><span class="line">        expect(res.body).to.be.an(<span class="string">"object"</span>);</span><br><span class="line">        expect(res.body.success).to.be.an(<span class="string">"boolean"</span>);</span><br><span class="line">        expect(res.body.data).to.be.an(<span class="string">"string"</span>);</span><br><span class="line">        done();</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="nuxt"><a href="#nuxt" class="headerlink" title="nuxt"></a>nuxt</h4><p><strong>vue 的服务器渲染</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Vue = <span class="built_in">require</span>(<span class="string">"vue"</span>);</span><br><span class="line"><span class="keyword">const</span> renderer = <span class="built_in">require</span>(<span class="string">"vue-server-renderer"</span>).createRenderer();</span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">"express"</span>)();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"*"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  renderer.renderToString(vm, (err, html) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(html);</span><br><span class="line">    res.end(html);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">8000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"server listening at http://localhost:8000"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  template: <span class="string">"&lt;h1&gt;hello,&#123;&#123;name&#125;&#125;&lt;/h1&gt;"</span>,</span><br><span class="line">  data: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name: <span class="string">"zhang"</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="nuxt-官方文档-https-zh-nuxtjs-org-guide"><a href="#nuxt-官方文档-https-zh-nuxtjs-org-guide" class="headerlink" title="nuxt 官方文档 https://zh.nuxtjs.org/guide/"></a>nuxt 官方文档 <a href="https://zh.nuxtjs.org/guide/" target="_blank" rel="noopener">https://zh.nuxtjs.org/guide/</a></h5><p><strong>nuxt 安装</strong><br>create-nuxt-app<project name><br><strong>nuxt 目录</strong><br><strong>nuxt 路由</strong><br>page 下的文件可以直接作为路由<br>1、基础路由<br>2、动态路由<br>3、路由参数校验<br>4、嵌套路由<br>5、动态嵌套路由</project></p><p>动态特效<br>1、全局过渡动效设置<br>2、页面过渡动效设置</p><p>中间件<br><strong>nuxt 视图</strong><br><strong>nuxt 异步数据</strong><br>asyncData 方法会在组件（限于页面组件）每次加载之前被调用。它可以在服务端或路由更新之前被调用。<br><strong>nuxt 资源文件</strong><br><strong>nuxt 插件</strong><br><strong>nuxt 模块</strong><br>Nuxt.js 团队提供 官方 模块:<br>@nuxt/http: 基于 ky-universal 的轻量级和通用的 HTTP 请求<br>@nuxtjs/axios: 安全和使用简单 Axios 与 Nuxt.js 集成用来请求 HTTP<br>@nuxtjs/pwa: 使用经过严格测试，更新且稳定的 PWA 解决方案来增强 Nuxt<br>@nuxtjs/auth: Nuxt.js 的身份验证模块，提供不同的方案和验证策略<br>Nuxt.js 社区制作的模块列表可在 <a href="https://github.com/topics/nuxt-module" target="_blank" rel="noopener">https://github.com/topics/nuxt-module</a> 中查询<br><strong>nuxt 状态树</strong><br><strong>支持 typescript</strong><br><strong>命令和部署</strong></p></div><footer class="article-footer"><div class="post-share"><a href="javascript:;" id="share-sub" class="post-share-fab"><i class="fa fa-share-alt"></i></a><div class="post-share-list" id="share-list"><ul class="share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://localhost:4000/2019/06/10/koa+nuxt基础/&title=《koa+nuxt基础》 — blog&pic=/images/banner.jpg" data-title="微博"><i class="fa fa-weibo"></i></a></li><li><a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信"><i class="fa fa-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://localhost:4000/2019/06/10/koa+nuxt基础/&title=《koa+nuxt基础》 — blog&source=一个专注前端智能化开发技术的网站" data-title="QQ"><i class="fa fa-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2019/06/10/koa+nuxt基础/" data-title="Facebook"><i class="fa fa-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《koa+nuxt基础》 — blog&url=http://localhost:4000/2019/06/10/koa+nuxt基础/&via=http://localhost:4000" data-title="Twitter"><i class="fa fa-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://localhost:4000/2019/06/10/koa+nuxt基础/" data-title="Google+"><i class="fa fa-google-plus"></i></a></li></ul></div></div><div class="post-modal wx-share" id="wxShare"><a class="close" href="javascript:;" id="wxShare-close">×</a><p>扫一扫，分享到微信</p><img src="//api.qrserver.com/v1/create-qr-code/?data=http://localhost:4000/2019/06/10/koa+nuxt基础/" alt="微信分享二维码"></div><div class="mask"></div><ul class="article-footer-menu"></ul></footer></div></article><aside class="post-toc-pos post-toc-top" id="post-toc"><nav class="post-toc-wrap"><ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#koa"><span class="post-toc-text">koa</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#一、开始"><span class="post-toc-text">一、开始</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#二、路由"><span class="post-toc-text">二、路由</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#三、请求数据"><span class="post-toc-text">三、请求数据</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#四、静态资源加载"><span class="post-toc-text">四、静态资源加载</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#五、cookie-和-session"><span class="post-toc-text">五、cookie 和 session</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#六、模板引擎"><span class="post-toc-text">六、模板引擎</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#七、文件上传"><span class="post-toc-text">七、文件上传</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#八、数据库-mysql"><span class="post-toc-text">八、数据库 mysql</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#九、jsonp"><span class="post-toc-text">九、jsonp</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#十、单元测试"><span class="post-toc-text">十、单元测试</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#nuxt"><span class="post-toc-text">nuxt</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#nuxt-官方文档-https-zh-nuxtjs-org-guide"><span class="post-toc-text">nuxt 官方文档 https://zh.nuxtjs.org/guide/</span></a></li></ol></li></ol></nav></aside><nav id="article-nav"><a href="/2019/07/25/iframe和定时器的思考/" id="article-nav-newer" class="article-nav-link-wrap"><span class="article-nav-title"><i class="fa fa-hand-o-left" aria-hidden="true"></i> iframe和定时器的思考 </span></a><a href="/2019/06/06/前端面试题整理/" id="article-nav-older" class="article-nav-link-wrap"><span class="article-nav-title">前端面试题整理</span> <i class="fa fa-hand-o-right" aria-hidden="true"></i></a></nav><div id="lv-container" data-id="city" data-uid="MTAyMC81MDE5Mi8yNjY4Mg=="><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div></section></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><p><span id="busuanzi_container_site_uv" style="display:none">总访客数：<span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" style="display:none">总访问量：<span id="busuanzi_value_site_pv"></span></span></p><p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="//github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a> &copy; 2020 Yang Pei<br></p></div></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><script>var mihoConfig={root:"http://localhost:4000",animate:"false",isHome:"false",share:"true"}</script><div class="sidebar"><div id="sidebar-top"><span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span></div></div><div class="sidebar-menu-box" id="sidebar-menu-box"><div class="sidebar-menu-box-container"><div id="sidebar-menu-box-categories"><a class="category-link" href="/categories/AI/">AI</a><a class="category-link" href="/categories/专题/">专题</a><a class="category-link" href="/categories/前端/">前端</a><a class="category-link" href="/categories/计算机/">计算机</a><a class="category-link" href="/categories/语言/">语言</a></div><div id="sidebar-menu-box-tags"></div></div><a href="javascript:;" class="sidebar-menu-box-close">&times;</a></div>ß<div class="mobile-header-menu-nav" id="mobile-header-menu-nav"><div class="mobile-header-menu-container"><span class="title">Menus</span><ul class="mobile-header-menu-navbar"><li><a href="/"><i class="fa fa-home"></i><span>主页</span></a></li><li><a href="/archives"><i class="fa fa-archive"></i><span>全部</span></a></li><li><a href="/categories/AI/"><i class="fa fa-AI"></i><span>AI</span></a></li><li><a href="/categories/前端/"><i class="fa fa-前端"></i><span>前端</span></a></li><li><a href="/categories/计算机/"><i class="fa fa-计算机"></i><span>计算机</span></a></li><li><a href="/categories/语言/"><i class="fa fa-语言"></i><span>语言</span></a></li><li><a href="/categories/专题/"><i class="fa fa-专题"></i><span>专题</span></a></li></ul></div><div class="mobile-header-tag-container"><span class="title">Tags</span><div id="mobile-header-container-tags"></div></div></div><div class="search-wrap"><span class="search-close">&times;</span> <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i> </a><input class="search-field" placeholder="Search..." id="keywords"> <a id="search-submit" href="javascript:;"><i class="fa fa-search"></i></a><div class="search-container" id="search-container"><ul class="search-result" id="search-result"></ul></div></div><div id="search-tpl"><li class="search-result-item"><a href="{url}" class="search-item-li"><span class="search-item-li-title" title="{title}">{title}</span></a></li></div><script src="/js/search.js"></script><script src="/js/main.js"></script><script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script><div id="particles"></div><script src="/js/particles.js"></script><script src="/js/pop-img.js"></script><script>$(".article-entry p img").popImg()</script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({model:{jsonPath:"/live2dw/assets/Epsilon2.1.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!1},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body>